# Ethereum单节点部署

通过本文所述方法和项目中的脚本，可以快速的搭建好自己的私链单节点进行开发测试。

仓库中包含的工具有：

* 一个测试账户导入脚本，在首次部署时将五个测试账户私钥导入以太坊节点。
* 一个genesis.json配置文件，为对应的五个测试账户提供初始资金（以太币），方便开发测试。
* 一个快速启动私有链节点并进入交互模式的脚本。

**测试账户私钥是放在Github上的公开数据，千万不要用于正式环境中或者公有链上。如果在测试环境之外的地方使用这些私钥，你的资金将会被窃取！**

## 准备

1. 在本地安装好[go-ethereum](https://github.com/ethereum/go-ethereum)可以执行`geth`命令。如果操作系统是ubuntu, 安装官方的ethereum安装包即可。

   ```shell
   Ubuntu 14.04环境，其他准备

   更改Ubuntu的apt源为阿里的
   参考： https://www.cnblogs.com/lyon2014/p/4715379.html
   更改/etc/apt.d/sources.list
   root@geth-node01:~# cat /etc/apt/sources.list
   deb http://mirrors.aliyun.com/ubuntu/ trusty main multiverse restricted universe
   deb http://mirrors.aliyun.com/ubuntu/ trusty-backports main multiverse restricted universe
   deb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main multiverse restricted universe
   deb http://mirrors.aliyun.com/ubuntu/ trusty-security main multiverse restricted universe
   deb http://mirrors.aliyun.com/ubuntu/ trusty-updates main multiverse restricted universe
   deb-src http://mirrors.aliyun.com/ubuntu/ trusty main multiverse restricted universe
   deb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main multiverse restricted universe
   deb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main multiverse restricted universe
   deb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main multiverse restricted universe
   deb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main multiverse restricted universe

   云环境的VM，根据情况需要手工更改/etc/resolve.conf，启用公网域名服务器8.8.8.8
   root@geth-node01:~# cat /etc/resolv.conf 
   # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
   #     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
   nameserver 8.8.8.8

   然后执行
   sudo apt-get update
   sudo apt-get install software-properties-common
   sudo add-apt-repository -y ppa:ethereum/ethereum
   sudo apt-get update
   sudo apt-get install ethereum
   ```

2. 安装git工具`sudo apt-get install git`，将本仓库通过`git clone`命令下载到本地。

3. 安装[expect](http://expect.sourceforge.net/)，工具脚本用它来自动化一些过程。例如在ubuntu上: `sudo apt-get install expect`

## 启动geth

1. 进入本仓库目录: `cd ethereum-bootstrap/1.SingleNode`

2. 导入测试账户私钥: `./import_keys.sh`，缺省的钱包密码设置为123456

3. 初始化blockchain: `./init_private_blockchain.sh`
   ```
   root@geth-node01:~/ethereum-bootstrap/1.SingleNode# ./init_private_blockchain.sh 
   INFO [04-12|15:47:41] Maximum peer count                       ETH=25 LES=0 total=25
   INFO [04-12|15:47:41] Allocated cache and file handles         database=/root/ethereum-bootstrap/1.SingleNode/data/geth/chaindata cache=16 handles=16
   INFO [04-12|15:47:41] Writing custom genesis block 
   INFO [04-12|15:47:41] Persisted trie from memory database      nodes=7 size=1.31kB time=70.539µs gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B
   INFO [04-12|15:47:41] Successfully wrote genesis state         database=chaindata                                                 hash=194258…f0efa3
   INFO [04-12|15:47:41] Allocated cache and file handles         database=/root/ethereum-bootstrap/1.SingleNode/data/geth/lightchaindata cache=16 handles=16
   INFO [04-12|15:47:41] Writing custom genesis block 
   INFO [04-12|15:47:41] Persisted trie from memory database      nodes=7 size=1.31kB time=498.815µs gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B
   INFO [04-12|15:47:41] Successfully wrote genesis state         database=lightchaindata                                                 hash=194258…f0efa3
   ```

4. 启动私有链节点: `./start_private_blockchain.sh`. 启动成功后可以看到类似如下输出:

  ```
  root@geth-node01:~/ethereum-bootstrap/1.SingleNode# ./start_private_blockchain.sh 
  INFO [04-12|15:47:45] Maximum peer count                       ETH=25 LES=0 total=25
  INFO [04-12|15:47:45] Starting peer-to-peer node               instance=Geth/v1.8.3-stable-329ac18e/linux-amd64/go1.10
  INFO [04-12|15:47:45] Allocated cache and file handles         database=/root/ethereum-bootstrap/1.SingleNode/data/geth/chaindata cache=768 handles=512
  WARN [04-12|15:47:45] Upgrading database to use lookup entries 
  INFO [04-12|15:47:45] Initialised chain configuration          config="{ChainID: 15 Homestead: 0 DAO: <nil> DAOSupport: false EIP150: <nil> EIP155: 0 EIP158: 0 Byzantium: <nil> Constantinople: <nil> Engine: unknown}"
  INFO [04-12|15:47:45] Disk storage enabled for ethash caches   dir=/root/ethereum-bootstrap/1.SingleNode/data/geth/ethash count=3
  INFO [04-12|15:47:45] Disk storage enabled for ethash DAGs     dir=/root/.ethash                                          count=2
  INFO [04-12|15:47:45] Initialising Ethereum protocol           versions="[63 62]" network=20180412
  INFO [04-12|15:47:45] Database deduplication successful        deduped=0
  INFO [04-12|15:47:45] Loaded most recent local header          number=0 hash=194258…f0efa3 td=131072
  INFO [04-12|15:47:45] Loaded most recent local full block      number=0 hash=194258…f0efa3 td=131072
  INFO [04-12|15:47:45] Loaded most recent local fast block      number=0 hash=194258…f0efa3 td=131072
  INFO [04-12|15:47:45] Regenerated local transaction journal    transactions=0 accounts=0
  INFO [04-12|15:47:45] Starting P2P networking 
  INFO [04-12|15:47:45] RLPx listener up                         self="enode://e6f8732c332d66fedd1bd74cc6fa6b528ea24db76f903f1d4bdf7b2aaaa45ac2c17a056225075bbebb48052c7097dd331de6983aa58b051f64c5622f4b3daed1@[::]:30303?discport=0"
  INFO [04-12|15:47:45] IPC endpoint opened                      url=/root/ethereum-bootstrap/1.SingleNode/data/geth.ipc
  INFO [04-12|15:47:45] HTTP endpoint opened                     url=http://127.0.0.1:8545                               cors=* vhosts=localhost
  Welcome to the Geth JavaScript console!

  instance: Geth/v1.8.3-stable-329ac18e/linux-amd64/go1.10
  INFO [04-12|15:47:46] Etherbase automatically configured       address=0xbD2d69E3e68e1ab3944a865B3E566CA5c48740da
  coinbase: 0xbd2d69e3e68e1ab3944a865b3e566ca5c48740da
  at block: 0 (Thu, 01 Jan 1970 00:00:00 UTC)
   datadir: /root/ethereum-bootstrap/1.SingleNode/data
   modules: admin:1.0 debug:1.0 eth:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 web3:1.0

  > 
  ```

5. 此时以太坊交互式控制台已经启动，我们可以开始测试和开发了。

注意：工具脚本假设你的geth安装在默认位置, 可以直接通过`geth`执行。如果`geth`命令安装在非标准的位置，可以设置`GETH`环境变量指定geth可执行文件的路径。

## 通过挖矿来为account发放ether
查看账号余额：
```
> web3.eth.getBalance(web3.eth.accounts[0])
4e+30
```
可以通过挖矿的方式给第一个账号发行ether：

第一次启动挖矿，会出现`Generating DAG in progress`当达到100%的时候，就会出现`Commit new mining work`说明挖矿成功。

```
> miner.start(1)
INFO [04-12|15:56:25] Generating DAG in progress               epoch=1 percentage=6  elapsed=23.167s
INFO [04-12|15:56:25] Successfully sealed new block            number=5 hash=17798f…35e7e5
INFO [04-12|15:56:25] 🔨 mined potential block                  number=5 hash=17798f…35e7e5
INFO [04-12|15:56:25] Commit new mining work                   number=6 txs=0 uncles=0 elapsed=187.16µs
INFO [04-12|15:56:28] Generating DAG in progress               epoch=1 percentage=7  elapsed=26.578s
INFO [04-12|15:56:31] Generating DAG in progress               epoch=1 percentage=8  elapsed=29.890s
INFO [04-12|15:56:34] Successfully sealed new block            number=6 hash=161716…3096c7
INFO [04-12|15:56:34] 🔗 block reached canonical chain          number=1 hash=e8c64a…dba8e9
INFO [04-12|15:56:34] 🔨 mined potential block                  number=6 hash=161716…3096c7
INFO [04-12|15:56:34] Commit new mining work                   number=7 txs=0 uncles=0 elapsed=148.93µs
INFO [04-12|15:56:35] Generating DAG in progress               epoch=1 percentage=9  elapsed=33.215s
INFO [04-12|15:56:39] Generating DAG in progress               epoch=1 percentage=10 elapsed=37.036s
INFO [04-12|15:56:42] Generating DAG in progress               epoch=1 percentage=11 elapsed=40.755s
INFO [04-12|15:56:46] Generating DAG in progress               epoch=1 percentage=12 elapsed=44.342s
INFO [04-12|15:56:49] Generating DAG in progress               epoch=1 percentage=13 elapsed=47.660s
INFO [04-12|15:56:53] Generating DAG in progress               epoch=1 percentage=14 elapsed=50.926s
INFO [04-12|15:56:56] Generating DAG in progress               epoch=1 percentage=15 elapsed=54.258s
INFO [04-12|15:56:56] Successfully sealed new block            number=7 hash=265246…80d943
INFO [04-12|15:56:56] 🔗 block reached canonical chain          number=2 hash=47020c…93bf48
INFO [04-12|15:56:56] 🔨 mined potential block                  number=7 hash=265246…80d943
INFO [04-12|15:56:56] Commit new mining work                   number=8 txs=0 uncles=0 elapsed=162.679µs
```
需要调用miner.stop来停止挖矿：
```
> miner.stop()
true
> web3.eth.getBalance(web3.eth.accounts[0])
4.00000000092e+30
```
其他的一些命令。

创建一个新的账号：

```
> personal.newAccount("123456")
"0xbf65120529316beed5858ed9b8add67a976f371e"
```

列出所有的账号：

```
> eth.accounts
["0xbd2d69e3e68e1ab3944a865b3e566ca5c48740da", "0x9da26fc2e1d6ad9fdd46138906b0104ae68a65d8", "0xca9f427df31a1f5862968fad1fe98c0a9ee068c4", "0x3ae88fe370c39384fc16da2c9e768cf5d2495b48", "0x81063419f13cab5ac090cd8329d8fff9feead4a0", "0xbf65120529316beed5858ed9b8add67a976f371e"]
```

以以太币单位显示账户余额（一以太币等于1e18 wei）：

```
> web3.fromWei(eth.getBalance(eth.accounts[0]), "ether")
4000000000920
```

在对账号进行操作（花费、转出账）之前，需要先对账号进行解锁：

```
> personal.unlockAccount(web3.eth.accounts[0])
```



